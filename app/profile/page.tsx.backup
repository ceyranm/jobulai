/**
 * Profil Sayfasƒ± (Profilim)
 * 
 * Kullanƒ±cƒ±nƒ±n t√ºm profil bilgilerini g√∂r√ºnt√ºleyip y√∂netebileceƒüi sayfa
 * Temel Bilgiler, Aday Bilgileri ve Belgeler b√∂l√ºmleri
 */

import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import ModernHeader from '@/components/modern-header';
import DocumentRow from '@/components/document-row';
import SubmitApplicationButton from '@/components/submit-application-button';
import ChangePasswordForm from '@/components/change-password-form';

export default async function ProfilePage() {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect('/auth/login');
  }

  // Profil bilgilerini al
  const { data: profile } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', user.id)
    .single();

  if (!profile) {
    redirect('/auth/login');
  }

  // Aday bilgilerini al (varsa)
  const { data: candidateInfo } = await supabase
    .from('candidate_info')
    .select('*')
    .eq('profile_id', user.id)
    .single();

  // Belgeleri al (her zaman g√ºncel veriyi almak i√ßin)
  const { data: documents, error: documentsError } = await supabase
    .from('documents')
    .select('*')
    .eq('profile_id', user.id)
    .order('updated_at', { ascending: false }); // En son g√ºncellenen √∂nce gelsin

  // Belge t√ºrlerini tanƒ±mla (sƒ±ra √∂nemli)
  const documentTypes = [
    { type: 'KIMLIK', label: 'Kimlik Belgesi', icon: 'üÜî' },
    { type: 'RESIDENCE', label: 'ƒ∞kametgah', icon: 'üè†' },
    { type: 'POLICE', label: 'Sabƒ±ka Kaydƒ±', icon: 'üîí' },
    { type: 'CV', label: 'CV', icon: 'üìÑ' },
    { type: 'DIPLOMA', label: 'Diploma', icon: 'üéì' },
  ];

/**
 * Profil Sayfasƒ± (Profilim)
 *
 * Kullanƒ±cƒ±nƒ±n t√ºm profil bilgilerini g√∂r√ºnt√ºleyip y√∂netebileceƒüi sayfa
 * Temel Bilgiler, Aday Bilgileri ve Belgeler b√∂l√ºmleri
 */

import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import ModernHeader from '@/components/modern-header';
import DocumentRow from '@/components/document-row';
import SubmitApplicationButton from '@/components/submit-application-button';
import ChangePasswordForm from '@/components/change-password-form';
import Footer from '@/components/footer';

export default async function ProfilePage() {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect('/auth/login');
  }

  // Profil bilgilerini al
  const { data: profile } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', user.id)
    .single();

  if (!profile) {
    redirect('/auth/login');
  }

  // Aday bilgilerini al (varsa)
  const { data: candidateInfo } = await supabase
    .from('candidate_info')
    .select('*')
    .eq('profile_id', user.id)
    .single();

  // Belgeleri al (her zaman g√ºncel veriyi almak i√ßin)
  const { data: documents, error: documentsError } = await supabase
    .from('documents')
    .select('*')
    .eq('profile_id', user.id)
    .order('updated_at', { ascending: false }); // En son g√ºncellenen √∂nce gelsin

  // Belge t√ºrlerini tanƒ±mla (sƒ±ra √∂nemli)
  const documentTypes = [
    { type: 'KIMLIK', label: 'Kimlik Belgesi', icon: 'üÜî' },
    { type: 'RESIDENCE', label: 'ƒ∞kametgah', icon: 'üè†' },
    { type: 'POLICE', label: 'Sabƒ±ka Kaydƒ±', icon: 'üîí' },
    { type: 'CV', label: 'CV', icon: 'üìÑ' },
    { type: 'DIPLOMA', label: 'Diploma', icon: 'üéì' },
  ];

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50/30 to-indigo-50/50 bg-grid-pattern">
      <ModernHeader
        title="Profilim"
        subtitle="Profil Bilgileri ve Belgeler"
        backLink={{
          href: `/dashboard/${profile.role.toLowerCase()}`,
          label: 'Ana Sayfa'
        }}
      />

      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
        {/* Welcome Section */}
        <div className="relative overflow-hidden bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600 rounded-3xl shadow-2xl p-8 md:p-12 text-white">
          <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIG9wYWNpdHk9IjAuMSI+PGcgZmlsbD0iI2ZmZiI+PGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMiIvPjwvZz48L2c+PC9zdmc+')] opacity-20"></div>
          <div className="relative z-10">
            <div className="flex items-start justify-between flex-wrap gap-4">
              <div>
                <h1 className="text-4xl md:text-5xl font-bold mb-3 bg-clip-text text-transparent bg-gradient-to-r from-white to-blue-100">
                  Profil Bilgilerim üë§
                </h1>
                <p className="text-blue-100 text-lg md:text-xl max-w-2xl">
                  Ki≈üisel bilgilerinizi g√∂r√ºnt√ºleyin ve y√∂netin.
                  {profile.role === 'CANDIDATE' && ' Belgelerinizi y√ºkleyip ba≈üvurunuzu takip edin.'}
                </p>
              </div>
              <div className="hidden md:flex items-center justify-center w-24 h-24 rounded-2xl bg-white/10 backdrop-blur-sm border border-white/20">
                <svg className="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              </div>
            </div>
          </div>
        </div>

        {/* Ba≈üvuru Durumu G√∂stergesi */}
        {profile.role === 'CANDIDATE' && profile.application_status && (
          <div className="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-100 p-8">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <div className="flex items-center gap-4">
                <div className={`p-3 rounded-xl ${
                  profile.application_status === 'NEW_APPLICATION' ? 'bg-blue-100' :
                  profile.application_status === 'EVALUATION' ? 'bg-yellow-100' :
                  profile.application_status === 'APPROVED' ? 'bg-green-100' :
                  profile.application_status === 'REJECTED' ? 'bg-red-100' :
                  'bg-orange-100'
                }`}>
                  <span className="text-2xl">
                    {profile.application_status === 'NEW_APPLICATION' ? 'üÜï' :
                     profile.application_status === 'EVALUATION' ? '‚è≥' :
                     profile.application_status === 'APPROVED' ? '‚úÖ' :
                     profile.application_status === 'REJECTED' ? '‚ùå' :
                     'üìù'}
                  </span>
                </div>
                <div>
                  <h3 className="text-xl font-bold text-gray-900 mb-1">Ba≈üvuru Durumu</h3>
                  <p className={`text-sm font-medium ${
                    profile.application_status === 'NEW_APPLICATION' ? 'text-blue-600' :
                    profile.application_status === 'EVALUATION' ? 'text-yellow-600' :
                    profile.application_status === 'APPROVED' ? 'text-green-600' :
                    profile.application_status === 'REJECTED' ? 'text-red-600' :
                    'text-orange-600'
                  }`}>
                    {profile.application_status === 'NEW_APPLICATION' ? 'Yeni Ba≈üvuru' :
                     profile.application_status === 'EVALUATION' ? 'Deƒüerlendirme A≈üamasƒ±nda' :
                     profile.application_status === 'APPROVED' ? 'Onaylandƒ±' :
                     profile.application_status === 'REJECTED' ? 'Reddedildi' :
                     'Bilgi/Evrak G√ºncelleme Gerekli'}
                  </p>
                </div>
              </div>
              {profile.application_status === 'EVALUATION' && (
                <div className="text-sm text-gray-600 max-w-md">
                  Ba≈üvurunuz deƒüerlendirme a≈üamasƒ±nda. Profil bilgileriniz bu a≈üamada d√ºzenlenemez.
                </div>
              )}
            </div>
          </div>
        )}

        {/* Profil Bilgileri */}
        <div className="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-100 p-8">
          <div className="flex items-center justify-between mb-8">
            <div className="flex items-center gap-4">
              <div className="p-3 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 shadow-lg">
                <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              </div>
              <div>
                <h2 className="text-2xl font-bold text-gray-900">Profil Bilgileri</h2>
                <p className="text-gray-600">Ki≈üisel bilgileriniz ve hesap detaylarƒ±nƒ±z</p>
              </div>
            </div>
            {profile.role === 'CANDIDATE' && (profile.application_status === 'NEW_APPLICATION' || profile.application_status === 'UPDATE_REQUIRED') && (
              <Link
                href="/profile/edit"
                className="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300 shadow-lg hover:shadow-xl hover:-translate-y-0.5"
              >
                <span className="flex items-center gap-2">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  D√ºzenle
                </span>
              </Link>
            )}
          </div>

          <div className="space-y-8">
            {/* Temel Bilgiler */}
            <div className="bg-gradient-to-br from-gray-50 to-gray-100/50 rounded-xl p-6">
              <h3 className="text-lg font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div className="p-2 rounded-lg bg-gray-200">
                  <svg className="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
                Temel Bilgiler
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="bg-white/60 rounded-lg p-4 border border-gray-200">
                  <label className="block text-sm font-medium text-gray-600 mb-2">
                    Ad Soyad
                  </label>
                  <p className="text-gray-900 font-medium">{profile.full_name || 'Belirtilmemi≈ü'}</p>
                </div>

                <div className="bg-white/60 rounded-lg p-4 border border-gray-200">
                  <label className="block text-sm font-medium text-gray-600 mb-2">
                    Telefon Numarasƒ±
                  </label>
                  <p className="text-gray-900 font-medium">{candidateInfo?.phone || 'Belirtilmemi≈ü'}</p>
                </div>

                <div className="bg-white/60 rounded-lg p-4 border border-gray-200">
                  <label className="block text-sm font-medium text-gray-600 mb-2">
                    TC Kimlik No
                  </label>
                  <p className="text-gray-900 font-medium">{candidateInfo?.national_id || 'Belirtilmemi≈ü'}</p>
                </div>

                <div className="bg-white/60 rounded-lg p-4 border border-gray-200">
                  <label className="block text-sm font-medium text-gray-600 mb-2">
                    Doƒüum Tarihi
                  </label>
                  <p className="text-gray-900 font-medium">
                    {candidateInfo?.date_of_birth
                      ? new Date(candidateInfo.date_of_birth).toLocaleDateString('tr-TR', {
                          year: 'numeric',
                          month: 'long',
                          day: 'numeric',
                        })
                      : 'Belirtilmemi≈ü'}
                  </p>
                </div>
              </div>
            </div>

            {/* Aday Bilgileri (Eƒüer CANDIDATE ise) */}
            {profile.role === 'CANDIDATE' && (
              <div className="bg-gradient-to-br from-emerald-50 to-teal-50/50 rounded-xl p-6">
                <h3 className="text-lg font-bold text-gray-900 mb-6 flex items-center gap-3">
                  <div className="p-2 rounded-lg bg-emerald-200">
                    <svg className="w-5 h-5 text-emerald-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                  </div>
                  Aday Bilgileri
                </h3>
                <div className="space-y-6">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="bg-white/60 rounded-lg p-4 border border-emerald-200">
                      <label className="block text-sm font-medium text-gray-600 mb-2">
                        E-posta
                      </label>
                      <p className="text-gray-900 font-medium">{user.email || candidateInfo?.email || 'Belirtilmemi≈ü'}</p>
                    </div>

                    <div className="bg-white/60 rounded-lg p-4 border border-emerald-200">
                      <label className="block text-sm font-medium text-gray-600 mb-2">
                        Kayƒ±t Tarihi
                      </label>
                      <p className="text-gray-900 font-medium">
                        {new Date(profile.created_at).toLocaleDateString('tr-TR', {
                          year: 'numeric',
                          month: 'long',
                          day: 'numeric',
                        })}
                      </p>
                    </div>

                    <div className="bg-white/60 rounded-lg p-4 border border-emerald-200">
                      <label className="block text-sm font-medium text-gray-600 mb-2">
                        Adres
                      </label>
                      <p className="text-gray-900 font-medium">{candidateInfo?.address || 'Belirtilmemi≈ü'}</p>
                    </div>

                    <div className="bg-white/60 rounded-lg p-4 border border-emerald-200">
                      <label className="block text-sm font-medium text-gray-600 mb-2">
                        Eƒüitim Seviyesi
                      </label>
                      <p className="text-gray-900 font-medium">{candidateInfo?.education_level || 'Belirtilmemi≈ü'}</p>
                    </div>

                    <div className="bg-white/60 rounded-lg p-4 border border-emerald-200">
                      <label className="block text-sm font-medium text-gray-600 mb-2">
                        Deneyim Yƒ±lƒ±
                      </label>
                      <p className="text-gray-900 font-medium">{candidateInfo?.experience_years || 0} yƒ±l</p>
                    </div>
                  </div>

                  <div className="bg-white/60 rounded-lg p-4 border border-emerald-200">
                    <label className="block text-sm font-medium text-gray-600 mb-3">
                      Beceriler
                    </label>
                    {candidateInfo?.skills && candidateInfo.skills.length > 0 ? (
                      <div className="flex flex-wrap gap-3">
                        {candidateInfo.skills.map((skill: string, index: number) => (
                          <span
                            key={index}
                            className="px-4 py-2 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-full text-sm font-medium shadow-md"
                          >
                            {skill}
                          </span>
                        ))}
                      </div>
                    ) : (
                      <p className="text-gray-900 font-medium">Belirtilmemi≈ü</p>
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>

        {/* Belgeler B√∂l√ºm√º (Sadece CANDIDATE i√ßin) */}
        {profile.role === 'CANDIDATE' && (
          <div id="documents" className="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-100 p-8">
            <div className="flex items-center justify-between mb-8">
              <div className="flex items-center gap-4">
                <div className="p-3 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 shadow-lg">
                  <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </div>
                <div>
                  <h2 className="text-2xl font-bold text-gray-900">Belgelerim</h2>
                  <p className="text-gray-600">Gerekli belgelerinizi y√ºkleyin ve durumlarƒ±nƒ± takip edin</p>
                </div>
              </div>
            </div>

            {/* Info Box */}
            <div className="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6 mb-8">
              <div className="flex items-start gap-4">
                <div className="p-3 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 shadow-lg">
                  <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
                <div>
                  <h4 className="font-bold text-blue-900 mb-2">Bilgi</h4>
                  <p className="text-sm text-blue-800">
                    Her belge t√ºr√ºnden bir belge y√ºkleyebilirsiniz. Belgeler consultant'lar tarafƒ±ndan incelendikten sonra onaylanacaktƒ±r.
                  </p>
                </div>
              </div>
            </div>

            {/* Belge Satƒ±rlarƒ± */}
            <div className="space-y-6">
              {documentTypes.map((docType) => {
                const document = documents?.find((doc) => doc.document_type === docType.type);
                return (
                  <DocumentRow
                    key={docType.type}
                    documentType={docType.type as 'CV' | 'POLICE' | 'RESIDENCE' | 'KIMLIK' | 'DIPLOMA'}
                    documentTypeLabel={docType.label}
                    documentTypeIcon={docType.icon}
                    document={document}
                    profileId={user.id}
                    canEdit={profile.role === 'CANDIDATE' && (profile.application_status === 'NEW_APPLICATION' || profile.application_status === 'UPDATE_REQUIRED')}
                    applicationStatus={profile.application_status || undefined}
                  />
                );
              })}
            </div>

            {/* Ba≈üvurumu Deƒüerlendirmeye G√∂nder Butonu */}
            <div className="mt-8 pt-6 border-t border-gray-200">
              <SubmitApplicationButton
                profileId={user.id}
                applicationStatus={profile.application_status}
                candidateInfo={candidateInfo}
                documents={documents || []}
                requiredDocumentTypes={documentTypes.map((dt) => dt.type)}
              />
            </div>
          </div>
        )}

        {/* ≈ûifre Yenileme B√∂l√ºm√º (Admin i√ßin) */}
        {profile.role === 'ADMIN' && (
          <div className="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-100 p-8">
            <div className="flex items-center gap-4 mb-6">
              <div className="p-3 rounded-xl bg-gradient-to-br from-rose-500 to-rose-600 shadow-lg">
                <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
              </div>
              <div>
                <h2 className="text-2xl font-bold text-gray-900">G√ºvenlik Ayarlarƒ±</h2>
                <p className="text-gray-600">≈ûifrenizi g√ºncelleyin ve hesabƒ±nƒ±zƒ± koruyun</p>
              </div>
            </div>
            <ChangePasswordForm />
          </div>
        )}
      </main>
      <Footer />
    </div>
  );
}
